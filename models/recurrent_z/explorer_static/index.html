<html>
    <head>
	<title>DCGAN Explorer</title>
	<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
	<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
	<script>
	 var height = 64;
	 var width = 64;
	 var border = 5;
	 var margin = 15;
	 var min_step = 0.1;
	 var max_step = 1.0;

	 function update_seek(value) {
	     var current = $("#timeline img").eq(value);
	     current.css({
		 "border-style":"solid",
		 "border-width":border+"px",
		 "border-color":"yellow",
		 "margin":(margin-border)+"px",
	     });
	     $("#timeline img").not(current).css({
		 "border-style":"none",
		 "margin":"15px",
	     });
	     $("#main-img").attr("src", current.attr("src"));
	 }

	 function tick() {
	     var max = $("#seek-slider").slider("option", "max");
	     var current = $("#seek-slider").slider("value");
	     current += 1;
	     if (current > max) {
		 current = 0;
	     }
	     update_seek(current);
	     $("#seek-slider").slider("value", current);
	 }

	 function request(url, params) {
	     $("#loading-message").dialog("open");
	     $.getJSON(url, params, update_everything);
	 }
	 
	 /* function run_test() {
	    $( "#loading-message" ).dialog("open");
	    $.getJSON("test_success", {}, update_everything);
	    }

	    function run_last() {
	    $( "#loading-message" ).dialog("open");
	    $.getJSON("test_last", {}, update_everything);
	    }*/

	 function update_everything(data, status, unused) {
	     $( "#loading-message" ).dialog("close");
	     if (data["response"] == "error") {
		 alert("Error! " + data["msg"]);
		 return;
	     }
	     msg = data["msg"]

	     // Update textareas
	     $("#video-txt").val(msg["video_zs"]);
	     $("#directions-txt").val(msg["directions"]);

	     // Update timeline
	     var timeline = $("#timeline");
	     timeline.empty();
	     $.each(msg["video_paths"], function(i, value) {
		 $('<img>').attr("src", value).css({
		     "width": width + "px",
		     "height": height + "px",
		     "float": "left",
		     "margin": margin + "px",
		 }).appendTo(timeline);
	     });
	     var n = msg["video_paths"].length;
	     if (n > 0) {
		 $("#seek-slider").slider("option", "disabled", false);
		 $("#seek-slider").slider("option", "max", n-1);
		 $("#seek-slider").slider("value", n-1);
		 update_seek(n-1);
	     } else {
		 $("#seek-slider").slider("option", "disabled", true);
		 $("#main-img").attr("src", "blank.jpg");
	     }

	     // Update selector
	     var selector = $("#selector");
	     selector.empty();
	     rows = msg["direction_paths"].length;
	     cols = msg["direction_paths"][0].length;
	     row_width = (width+2*margin)*cols;
	     row_height = height+2*margin;
	     for (r = 0; r < rows; r++) {
		 row_div = $('<div>').css({
		     "width": row_width + "px",
		     "height": row_height + "px",
		 });
		 for (c = 0; c < cols; c++) {
		     src = msg["direction_paths"][r][c];
		     $('<img>').attr("src", src).css({
			 "width": width + "px",
			 "height": height + "px",
			 "float": "left",
			 "margin": margin + "px",
		     }).appendTo(row_div);
		 }
		 row_div.appendTo(selector);
	     }
	 }

	 function get_slider_value(input_val) {
	     var slider = $("#step-size-slider");
	     if (input_val == undefined) {
		 input_val = slider.slider("value");
	     }
	     var min_val = slider.slider("option", "min");
	     var max_val = slider.slider("option", "max");
	     var delta_val = max_val - min_val;
	     var delta_step = max_step - min_step;
	     return (input_val - min_val) * (delta_step / delta_val) + min_step;
	 }
	 
	 $( function() {
	     var play_interval = null;
	     $( "button" ).button();
	     /* $( "button" ).click( function( event ) {
		event.preventDefault();
		} );*/
	     $( "#loading-message" ).dialog({
		 modal: true,
		 autoOpen: false,
	     });
	     $("#play").click( function(event) {
		 fps = parseInt($("#fps").val());
		 if (isNaN(fps)) {
		     alert("Can't parse FPS");
		     return;
		 }
		 period = 1000.0 / fps;
		 if (period < 20) {
		     alert("FPS too large");
		     return;
		 }
		 if (play_interval) {
		     return;
		 }
		 play_interval = setInterval(tick, period);
	     });
	     $("#stop").click( function(event) {
		 if (play_interval) {
		     clearInterval(play_interval);
		     play_interval = null;
		 }
	     });
	     $("#choose_init_face").click(function() {
		 request("choose_init_face", {});
	     });
	     $("#last").click(function() {
		 request("test_last", {});
	     });
	     $("#init_face").click(function() {
		 request("init_face", {
		     "step_size": get_slider_value(),
		 });
	     });
	     $("#init_directions").click(function() {
		 request("init_directions", {
		     "step_size": get_slider_value(),
		 });
	     });
	     $("#clear_directions").click(function() {
		 request("clear_directions", {});
	     });

	     $("#step-size-slider").slider({
		 min: 0,
		 max: 100,
		 value: 0,
		 stop: function( event, ui ) {
		     request("update_step_size", {
			 "step_size": get_slider_value(),
		     });
		     /* $( "#loading-message" ).dialog("open");
			setTimeout(function() { $( "#loading-message" ).dialog("close"); }, 1000);*/
		 },
		 slide: function( event, ui) {
		     var value = get_slider_value(ui.value);
		     $("#step-size").text("Step value: " + value);
		 }
	     });
	     $("#seek-slider").slider({
		 min: 0,
		 max: 15,
		 range: "min",
		 value: 0,
		 slide: function( event, ui) {
		     update_seek(ui.value);
		 }
	     });

	     var value = get_slider_value();
	     $("#step-size").text("Step value: " + value);
	 } );
	</script>
    </head>
    <body>

	<div id="loading-message" title="Loading...">
	    <p>
		Please wait as the page updates ...
	    </p>
	</div>

	<!-- LEFT 50% -->
	<div style="width: 45%; height: 100%; float: left;">
	    <!-- TOP LEFT -->
	    <div style="height:75%;width:100%;overflow:auto">
		<button class="ui-button ui-widget ui-corner-all" id="init_face">Random Initial Face</button>
		<button class="ui-button ui-widget ui-corner-all" id="init_directions">Random Directions</button>
		<button class="ui-button ui-widget ui-corner-all" id="clear_directions">Clear Directions</button>
		<button class="ui-button ui-widget ui-corner-all" id="choose_init_face">Random Grid of Faces</button>
		<button class="ui-button ui-widget ui-corner-all" id="last">Last</button>
		<br/>
		<br/>
		<div id="step-size-slider" style="margin-left:50px;margin-right:50px"></div>
		<p id="step-size">Step value: ??</p>
		<p>Current video description <button class="ui-button ui-widget ui-corner-all">Load</button></p>
		<textarea id="video-txt" style="width:100%" rows="1">text</textarea>
		<p>Current directions <button class="ui-button ui-widget ui-corner-all">Load</button></p>
		<textarea id="directions-txt" style="width:100%" rows="1">text</textarea>
		<p style="text-align:center">Video so far</p>
		<img id="main-img" src="blank.jpg"
		     style="display:block;margin-left:auto;margin-right:auto;width:128px;height:128px">
		<br/>
		<div id="seek-slider" style="margin-left:50px;margin-right:50px"></div>
		<br/>
		<button class="ui-button ui-widget ui-corner-all" id="play">Play</button>
		<button class="ui-button ui-widget ui-corner-all" id="stop">Stop</button>
		<label>FPS: <input type="text" id="fps"></label>
	    </div>

	    <!-- BOTTOM LEFT -->
	    <div style="height:25%;width:100%;overflow:auto">
		<div id="timeline">
		</div>
	    </div>
	</div>

	<!-- RIGHT 50% -->
	<div id="selector" style="width:45%;height:100%;float:right;overflow:auto">
	</div>
    </body>
</html>
